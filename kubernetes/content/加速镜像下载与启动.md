# 加速镜像下载与启动：支持容器快速弹性

在容器的启动过程中，镜像下载速度往往是影响启动速度的最主要因素，通常占据了启动时间的 70% 以上。特别是对于体积庞大的 AI 镜像，它们的大小可能达到数十 GB，导致下载和解压速度都成为启动的瓶颈。本文将探讨镜像下载的主要瓶颈、常见的优化方案以及最新的按需加载技术，以加速容器启动。

## 镜像下载速度慢的原因
容器镜像下载慢的原因主要有以下几点：
- 镜像体积过大：AI 镜像体积通常较大，可能达到数十 GB，使得下载时间显著。
- gzip 解压耗时：特别是在内网环境中，解压时间往往远高于网络传输时间，导致解压成为新的瓶颈。
- 镜像仓库瓶颈：镜像仓库的带宽有限，在高并发场景下，中心化的镜像仓库会成为瓶颈，下载速度会受到限制。

## 当前 OCI 镜像存在的问题

### oci 镜像结构
![docker-oci](/imgs/image-oci.png)
![docker-oci2](/imgs/image-oci2.png)

特点：
- Image is a set of tar (+compression) layers
- Non seekable: 镜像层是 tar 格式，不支持随机访问，必须顺序读取。
- No parallel extraction: 镜像层是 tar 格式，不支持并行解压，必须顺序解压。

带来的问题：
- 容器启动前必须等待所有镜像层下载完成，才能开始解压，导致启动延迟增加。
- 镜像层是 tar 格式，不支持并行解压，必须顺序解压。
- 即使容器只使用了镜像的一部分，也必须等待所有层下载解压完成。


## 常见的镜像优化思路
### 传统方案
- 镜像缓存/预加载

    传统方案就是在机器上缓存拉取过的镜像层（当然，docker已经支持了这一功能），并配置pod的imagePolicy为IfNotPresent，镜像的分层让不同镜像之间可以对层进行共享，从而减少拉取其他镜像的时延。
    
    这种方案需要在机器上预下载所需的镜像，以确保在启动时可以直接从缓存中获取镜像层，而无需再次从镜像仓库下载。为了增加命中，需要提前预下载足够多的镜像，但是会大量消耗机器的磁盘空间。

    ![docker-layer](/imgs/docker-layer.png)

  
    
- 减小镜像大小

    减少镜像体积也有助于缩短下载时间，但在某些场景下，例如 AI、CUDA 镜像，体积优化空间有限。它们通常需要使用超过 十几 GB 的存储空间，难以进一步缩减。

### 镜像按需加载 + p2p 加速

容器镜像原生加载



## 参考资料
- [镜像加速之路——镜像延迟加载技术解析](https://zhuanlan.zhihu.com/p/346829631)
- [加速容器镜像下载：从缓存到按需加载](https://oilbeater.com/2024/10/31/docker-pull)
- [SOCI Snapshotter](https://github.com/awslabs/soci-snapshotter)
- [Lazy Container Image Distribu4on With eStargz And P2P Image Sharing on IPFS](https://indico.cern.ch/event/1079490/contributions/4939494/attachments/2507120/4308126/snapshotter.pdf)
- [Toward Next Generation Container Image](https://drive.google.com/file/d/1LRfLUkNxShxxWU7SKjc_50U0N9ZnGIdV/view?pli=1)
- [Nydus —— 下一代容器镜像的探索实践](https://www.sofastack.tech/blog/nydus-exploratory-practice-of-next-generation-container-images/)
- [accelerated-container-image](https://github.com/containerd/accelerated-container-image)
- [Startup Containers in Lightning Speed with Lazy Image Distribution on Containerd](https://medium.com/nttlabs/startup-containers-in-lightning-speed-with-lazy-image-distribution-on-containerd-243d94522361)
